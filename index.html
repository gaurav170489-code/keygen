<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeyGen Pro</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        :root { --primary: #007AFF; --success: #34C759; --whatsapp: #25D366; --bg: #F2F2F7; --error: #FF3B30; --gray: #E5E5EA; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        .app-container { width: 85%; max-width: 350px; background: white; padding: 25px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; display: none; }
        .login-container { width: 85%; max-width: 300px; background: white; padding: 30px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; }

        h2 { margin-top: 0; color: #1C1C1E; font-size: 22px; margin-bottom: 20px;}
        .input-group { margin-bottom: 20px; text-align: left; position: relative; }
        label { display: block; font-size: 11px; color: #8E8E93; margin-bottom: 6px; text-transform: uppercase; font-weight: 700; }
        
        input { width: 100%; padding: 14px; border: 1px solid #D1D1D6; border-radius: 12px; font-size: 16px; box-sizing: border-box; background: #F2F2F7; color: #1C1C1E; font-family: inherit; -webkit-appearance: none; text-align: center;}
        input:focus { outline: none; border-color: var(--primary); }
        input[type="date"] { text-align: left; }

        /* TYPE SELECTOR STYLES */
        .type-selector { display: flex; background: var(--gray); border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .type-option { flex: 1; padding: 8px; font-size: 14px; font-weight: 600; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.2s; color: #8E8E93; }
        .type-option.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .ghost-user {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
            opacity: 1; 
        }

        .key-box { background: #F2F2F7; padding: 15px; border-radius: 16px; font-size: 38px; font-weight: 800; color: var(--primary); letter-spacing: 4px; margin: 10px 0; border: 2px dashed #D1D1D6; }

        .btn { border: none; width: 100%; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-copy { background: white; color: var(--primary); border: 2px solid var(--primary); padding: 13px; }
        .btn-wa { background: var(--whatsapp); color: white; }
        button:active { transform: scale(0.97); opacity: 0.9; }
        
        .today-link { display: block; color: #8E8E93; font-size: 13px; text-decoration: none; margin-top: 15px; cursor: pointer;}
        .error-msg { color: var(--error); font-size: 13px; margin-top: 10px; display: none; font-weight: 600;}

        #toast { visibility: hidden; background-color: #1C1C1E; color: white; padding: 12px 24px; border-radius: 50px; position: fixed; bottom: 50px; font-size: 14px; font-weight: 500; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: pop 0.3s ease-out, fadeout 0.3s 1.7s ease-in forwards; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeout { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>

<iframe name="authFrame" id="authFrame" style="display: none;"></iframe>

<div class="login-container" id="loginScreen">
    <h2>üîê Secure Login</h2>
    <form id="loginForm" target="authFrame" action="" method="POST">
        <input type="text" name="username" value="KeyGenAdmin" autocomplete="username" class="ghost-user" tabindex="-1">
        <div class="input-group">
            <label style="text-align: center;">Enter Access PIN</label>
            <input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" name="password">
        </div>
        <button type="submit" class="btn btn-main">Unlock App</button>
        <div class="error-msg" id="errorMsg">Incorrect PIN</div>
    </form>
</div>

<div class="app-container" id="appScreen">
    <h2>Access Key</h2>

    <div class="type-selector">
        <div class="type-option active" onclick="setType('P')" id="opt-P">P-Type</div>
        <div class="type-option" onclick="setType('R')" id="opt-R">R-Type</div>
        <div class="type-option" onclick="setType('D')" id="opt-D">D-Type</div>
    </div>
    
    <form id="mainForm" autocomplete="off">
        <div class="input-group">
            <label>Verification Date</label>
            <input type="date" id="datePicker" autocomplete="off">
        </div>
    </form>
    <div class="key-box" id="keyDisplay">------</div>
    <button class="btn btn-main" onclick="calculate()">Generate Key</button>
    <button class="btn btn-copy" id="copyBtn" onclick="copyKey()"><span>üìã</span> Copy to Clipboard</button>
    <button class="btn btn-wa" onclick="shareWhatsApp()"><span>üí¨</span> Share via WhatsApp</button>
    <a class="today-link" onclick="hardReset()">Reset to Today</a>
    <a class="today-link" style="color: #FF3B30; margin-top: 20px;" onclick="logout()">Logout</a>
</div>

<div id="toast">Key Copied!</div>

<script>
    // SHA-256 for "123apart"
    const STORED_HASH = "9baa63b1afeeba63e13c042b3d5379a731b02f7ace2b4ea08d6f3b9c306b2514"; 

    // CURRENT TYPE STATE (Default: P)
    let currentType = 'P';

    function setType(type) {
        currentType = type;
        // Update UI classes
        document.querySelectorAll('.type-option').forEach(el => el.classList.remove('active'));
        document.getElementById(`opt-${type}`).classList.add('active');
        // Clear result on switch
        document.getElementById('keyDisplay').innerText = "------";
    }

    // --- LOGIN HANDLER ---
    document.getElementById('loginForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const input = document.getElementById('passwordInput').value;
        const error = document.getElementById('errorMsg');
        const inputHash = await sha256(input);

        if (inputHash === STORED_HASH) {
            sessionStorage.setItem('isLoggedIn', 'true');
            this.submit();
            document.getElementById('passwordInput').blur();
            setTimeout(() => { showApp(); }, 500);
        } else {
            error.style.display = 'block';
            document.getElementById('passwordInput').value = '';
        }
    });

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function showApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        setTimeout(hardReset, 0); 
    }

    function logout() {
        sessionStorage.removeItem('isLoggedIn');
        location.reload();
    }

    window.onload = function() {
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            showApp();
        }
    };

    function hardReset() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        document.getElementById('mainForm').reset();
        const picker = document.getElementById('datePicker');
        picker.value = `${y}-${m}-${d}`;
        document.getElementById('keyDisplay').innerText = "------";
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            if (sessionStorage.getItem('isLoggedIn') === 'true' && document.getElementById('keyDisplay').innerText === "------") {
                hardReset();
            }
        }
    });

    // --- CALCULATION LOGIC ---
    function calculate() {
        const dateInput = document.getElementById('datePicker').value;
        if (!dateInput) { hardReset(); return; }

        const [year, month, day] = dateInput.split('-').map(num => parseInt(num, 10));
        const mmStr = String(month).padStart(2, '0');
        let resultKey = "";

        if (currentType === 'P') {
            const dd = day; const mm = month; const yy = year % 100; const secretSalt = 0xAF21; 
            let shuffle = Math.abs(Math.sin(dd * 12.9898 + mm * 78.233 + yy * 4.1414) * 43758.5453);
            let scrambleFactor = Math.floor(shuffle) % 100000;
            let baseResult = (dd % 2 === 0) ? (dd * 157) ^ (yy + secretSalt) : (dd * 241) ^ (mm * secretSalt);
            let finalResult = (baseResult ^ scrambleFactor) % 1000000;
            resultKey = Math.abs(finalResult).toString().padStart(6, '0');

        } else if (currentType === 'R') {
            const calc = (day * 91) + 35;
            const X = String(calc).padStart(4, '0');
            const X_rev = X.split('').reverse().join(''); 
            const Y = mmStr.split('').reverse().join(''); 
            const sum = parseInt(X_rev) + parseInt(Y);
            resultKey = String(sum);

        } else if (currentType === 'D') {
            const yy = year % 100;
            const calc = (day * 91) + 35;
            const X = String(calc).padStart(4, '0');
            const X_rev = X.split('').reverse().join('');
            const Y = mmStr.split('').reverse().join('');
            const sum = parseInt(X_rev) + parseInt(Y);

            const calc1 = day * yy;
            const X1_str = String(calc1);
            const X1_rev = X1_str.split('').reverse().join('');
            const sum1 = parseInt(X1_rev); 
            resultKey = String(sum) + String(sum1);
        }

        document.getElementById('keyDisplay').innerText = resultKey;
    }

    function copyKey() {
        const key = document.getElementById('keyDisplay').innerText;
        if (key === "------") return alert("Generate key first!");
        navigator.clipboard.writeText(key).then(() => {
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(() => { toast.className = ""; }, 2000);
        });
    }

    function shareWhatsApp() {
        const key = document.getElementById('keyDisplay').innerText;
        const dateInput = document.getElementById('datePicker').value; // YYYY-MM-DD
        
        if (key === "------") return alert("Generate key first!");

        // 1. Parse date parts
        const [year, month, day] = dateInput.split('-');
        
        // 2. Convert Month Number to Name (JAN, FEB...)
        const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const monthIndex = parseInt(month, 10) - 1;
        const formattedDate = `${day}-${monthNames[monthIndex]}-${year}`;

        // 3. Construct Message: "[P] 02-FEB-2026 ‚û§  014842"
        const message = `[${currentType}] ${formattedDate} ‚û§  ${key}`;

        window.location.href = `whatsapp://send?text=${encodeURIComponent(message)}`;
    }
</script>

</body>
</html>
